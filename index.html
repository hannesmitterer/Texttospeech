<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio-Zusammenfassung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center p-4 md:p-8">

    <div class="max-w-3xl w-full space-y-6">
        <header class="text-center space-y-2">
            <h1 class="text-4xl font-bold text-slate-800">Audio-Zusammenfassung</h1>
            <p class="text-slate-600">Verwandle lange Texte in prägnante, gesprochene Audios.</p>
        </header>

        <main class="glass-morphism p-6 rounded-2xl shadow-xl space-y-4">
            <div>
                <label for="inputText" class="block text-sm font-medium text-slate-700 mb-2">Dein Text / Synopsis</label>
                <textarea id="inputText" rows="8" 
                    class="w-full p-4 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none"
                    placeholder="Füge hier den Text ein, den du zusammenfassen und hören möchtest..."></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Sprecher-Stimme</label>
                    <select id="voiceSelect" class="w-full p-3 border border-slate-200 rounded-lg bg-white outline-none">
                        <option value="Kore">Kore (Klar & Professionell)</option>
                        <option value="Zephyr">Zephyr (Warm & Sanft)</option>
                        <option value="Charon">Charon (Tief & Autoritär)</option>
                        <option value="Puck">Puck (Energetisch)</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="generateBtn" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform active:scale-95 flex justify-center items-center gap-2">
                        <span id="btnText">Zusammenfassen & Sprechen</span>
                        <div id="loadingSpinner" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                </div>
            </div>

            <div id="statusMsg" class="hidden p-3 rounded-lg text-sm text-center"></div>

            <div id="audioContainer" class="hidden space-y-3 pt-4 border-t border-slate-100">
                <h3 class="font-semibold text-slate-800">Deine Audio-Zusammenfassung:</h3>
                <audio id="audioPlayer" controls class="w-full"></audio>
                <div id="summaryText" class="text-sm text-slate-600 italic bg-slate-100 p-4 rounded-lg border-l-4 border-blue-400"></div>
            </div>
        </main>
        
        <footer class="text-center text-slate-400 text-xs">
            Resonance School Initiative &bull; powered by Gemini AI
        </footer>
    </div>

    <script>
        const apiKey = ""; // Wird zur Laufzeit bereitgestellt
        const generateBtn = document.getElementById('generateBtn');
        const btnText = document.getElementById('btnText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const inputText = document.getElementById('inputText');
        const voiceSelect = document.getElementById('voiceSelect');
        const statusMsg = document.getElementById('statusMsg');
        const audioContainer = document.getElementById('audioContainer');
        const audioPlayer = document.getElementById('audioPlayer');
        const summaryTextDisplay = document.getElementById('summaryText');

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                    if (response.status === 429 || response.status >= 500) {
                        await new Promise(resolve => setTimeout(resolve, backoff));
                        backoff *= 2;
                        continue;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    backoff *= 2;
                }
            }
        }

        async function generateSummary(text) {
            const systemPrompt = "Fasse den folgenden Text kurz und prägnant in 3-4 Sätzen auf Deutsch zusammen. Konzentriere dich auf die wichtigsten Kernpunkte.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const data = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Zusammenfassung konnte nicht erstellt werden.";
        }

        async function generateAudio(text, voice) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: `Sprich die folgende Zusammenfassung klar und deutlich: ${text}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voice }
                        }
                    }
                }
            };

            const response = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const audioData = response.candidates?.[0]?.content?.parts?.[0]?.inlineData;
            if (!audioData) throw new Error("Keine Audiodaten erhalten.");

            return audioData;
        }

        // Hilfsfunktion: PCM16 zu WAV (Gemini TTS liefert L16)
        function pcmToWav(base64Data, sampleRate = 24000) {
            const binaryString = atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const buffer = bytes.buffer;
            
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            view.setUint32(0, 0x52494646, false); // "RIFF"
            view.setUint32(4, 36 + buffer.byteLength, true);
            view.setUint32(8, 0x57415645, false); // "WAVE"
            view.setUint32(12, 0x666d7420, false); // "fmt "
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            view.setUint32(36, 0x64617461, false); // "data"
            view.setUint32(40, buffer.byteLength, true);

            const combined = new Uint8Array(wavHeader.byteLength + buffer.byteLength);
            combined.set(new Uint8Array(wavHeader), 0);
            combined.set(new Uint8Array(buffer), wavHeader.byteLength);

            return new Blob([combined], { type: 'audio/wav' });
        }

        generateBtn.addEventListener('click', async () => {
            const text = inputText.value.trim();
            if (!text) {
                showMessage("Bitte gib zuerst einen Text ein.", "bg-red-100 text-red-700");
                return;
            }

            setLoading(true);
            audioContainer.classList.add('hidden');

            try {
                // Schritt 1: Text zusammenfassen
                const summary = await generateSummary(text);
                summaryTextDisplay.innerText = summary;

                // Schritt 2: Audio generieren
                const voice = voiceSelect.value;
                const audioResult = await generateAudio(summary, voice);
                
                // Mime-Type aus dem Resultat extrahieren (normalerweise audio/L16;rate=24000)
                const rateMatch = audioResult.mimeType.match(/rate=(\d+)/);
                const sampleRate = rateMatch ? parseInt(rateMatch[1]) : 24000;

                const audioBlob = pcmToWav(audioResult.data, sampleRate);
                const audioUrl = URL.createObjectURL(audioBlob);
                
                audioPlayer.src = audioUrl;
                audioContainer.classList.remove('hidden');
                showMessage("Zusammenfassung erfolgreich erstellt!", "bg-green-100 text-green-700");
            } catch (error) {
                console.error(error);
                showMessage("Fehler bei der Verarbeitung. Bitte versuche es erneut.", "bg-red-100 text-red-700");
            } finally {
                setLoading(false);
            }
        });

        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            btnText.innerText = isLoading ? "Verarbeite..." : "Zusammenfassen & Sprechen";
            loadingSpinner.classList.toggle('hidden', !isLoading);
            if (isLoading) {
                statusMsg.classList.add('hidden');
            }
        }

        function showMessage(msg, classes) {
            statusMsg.innerText = msg;
            statusMsg.className = `p-3 rounded-lg text-sm text-center ${classes}`;
            statusMsg.classList.remove('hidden');
        }
    </script>
</body>
</html>
